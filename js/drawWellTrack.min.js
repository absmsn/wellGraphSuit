function initSpatialTrack(){var e,t,n,i,r=!0,o=10,a=10,s=2,c=.3,l="#ff0000",E="#00ff00",d="#0000ff",u="#8a2be2",m="#8a2be2",f="#8a2be2",h=baseColor,T=baseColor,g=baseColor,p=baseColor;if(configObj&&configObj.spatialTrack){var R=configObj.spatialTrack;o=R.xyGridNum||o,a=R.zGridNum||a,l=R.xAxisColor||l,E=R.yAxisColor||E,d=R.zAxisColor||d,h=R.fontColor||h,s=R.maxZToXyRatio||s,p=R.realVerticalLineColor||p,T=R.realTrackLineColor||T,g=R.realProjectionLineColor||g,u=R.designVerticalLineColor||u,m=R.designTrackLineColor||m,f=R.designProjectionLineColor||f,c=R.fontSizeToUnitRatio||c,"boolean"==typeof R.autoRotate&&(r=R.autoRotate)}var w=new THREE.LineBasicMaterial({color:l,side:THREE.DoubleSide}),y=new THREE.LineBasicMaterial({color:E,side:THREE.DoubleSide}),H=new THREE.LineBasicMaterial({color:d,side:THREE.DoubleSide}),x=new THREE.LineBasicMaterial({color:T,side:THREE.DoubleSide}),v=new THREE.LineBasicMaterial({color:g,side:THREE.DoubleSide}),P=new THREE.LineBasicMaterial({color:m,side:THREE.DoubleSide}),M=new THREE.LineBasicMaterial({color:f,side:THREE.DoubleSide}),b=Math.max.apply(null,realDepths.concat(designDepths)),L=xyFarthest;b/xyFarthest>s&&(L=b/s),n=getApproximateGridSize(L,o,factorArray),L=fMul(o,n),i=getApproximateGridSize(b,a,factorArray),b=fMul(a,i);var k=function(e){return fSub(b,e)},B={min:-L,max:L},j={min:-L,max:L},D={min:k(b),max:k(0)},G=10,S=1/3,V=b-Math.max.apply(null,realDepths),z=new THREE.LineDashedMaterial({color:p,dashSize:V/G*(1-S),gapSize:V/G*S}),F=b-Math.max.apply(null,designDepths),C=new THREE.LineDashedMaterial({color:u,dashSize:F/G*(1-S),gapSize:F/G*S}),O=n/2,A=n,N=document.getElementById("spatialTrack");N.style.display="";var I=new THREE.WebGLRenderer({antialias:!0,canvas:N,preserveDrawingBuffer:!0});I.setSize(N.offsetWidth,N.offsetHeight),I.setClearColor(new THREE.Color("white"));var W=new THREE.Scene,X=new THREE.PerspectiveCamera(45,N.offsetWidth/N.offsetHeight,1,1e5);X.up.x=0,X.up.y=0,X.up.z=1,X.position.set(-L,-L,D.max),X.lookAt(0,0,D.min);var Y=new THREE.OrbitControls(X,N);Y.enableDamping=!0,Y.autoRotate=r,e=new THREE.Group,e.name="realDrillLines";var K=realTrackPoints.map(function(e){return new THREE.Vector3(e.x,e.y,k(e.depth))});geometry=(new THREE.BufferGeometry).setFromPoints(K);var U=new THREE.Line(geometry,x);e.add(U);K=realTrackPoints.map(function(e){return new THREE.Vector3(e.x,e.y,0)});geometry=(new THREE.BufferGeometry).setFromPoints(K);var q=new THREE.Line(geometry,v);e.add(q);K=[];for(var J=0;J<realTrackPoints.length;J++){var Z=realTrackPoints[J];K.push(new THREE.Vector3(Z.x,Z.y,k(Z.depth))),K.push(new THREE.Vector3(Z.x,Z.y,0))}geometry=(new THREE.BufferGeometry).setFromPoints(K);var _=new THREE.LineSegments(geometry,z);_.computeLineDistances(),e.add(_),W.add(e),t=new THREE.Group,t.name="designDrillLines";K=designTrackPoints.map(function(e){return new THREE.Vector3(e.x,e.y,k(e.depth))});geometry=(new THREE.BufferGeometry).setFromPoints(K);U=new THREE.Line(geometry,P);t.add(U);K=designTrackPoints.map(function(e){return new THREE.Vector3(e.x,e.y,0)});geometry=(new THREE.BufferGeometry).setFromPoints(K);q=new THREE.Line(geometry,M);t.add(q);for(K=[],J=0;J<designTrackPoints.length;J++){Z=designTrackPoints[J];K.push(new THREE.Vector3(Z.x,Z.y,k(Z.depth))),K.push(new THREE.Vector3(Z.x,Z.y,0))}geometry=(new THREE.BufferGeometry).setFromPoints(K);_=new THREE.LineSegments(geometry,C);_.computeLineDistances(),t.add(_),W.add(t),useFont(function(e){for(var t=n*c,r=n/20,o=new THREE.MeshBasicMaterial({color:h,side:THREE.DoubleSide}),a=0;a<=(B.max-B.min)/n;a++){var s=fAdd(B.min,fMul(n,a)).toString(),l=new THREE.TextGeometry(s,{font:e,size:t,height:r}),E=new THREE.Mesh(l,o);E.position.x=B.min+n*a-t/2,E.position.y=B.min-t,E.position.z=-r/2,E.rotation.z=-Math.PI/2,W.add(E)}for(a=0;a<=(j.max-j.min)/n;a++){s=fAdd(j.min,fMul(n,a)).toString(),l=new THREE.TextGeometry(s,{font:e,size:t,height:r}),E=new THREE.Mesh(l,o);var d=(new THREE.Box3).setFromObject(E);E.position.x=j.min-t-(d.max.x-d.min.x),E.position.y=j.min+n*a-t/2,E.position.z=-r/2,W.add(E)}for(a=0;a<=(D.max-D.min)/i;a++){s=fSub(b,fMul(i,a)).toString(),l=new THREE.TextGeometry(s,{font:e,size:t,height:r}),E=new THREE.Mesh(l,o);E.position.x=t/2,E.position.y=-r/2,E.position.z=D.min+i*a-t/2,E.rotation.x=Math.PI/2,W.add(E)}l=new THREE.TextGeometry("X(E)",{font:e,size:t,height:r}),E=new THREE.Mesh(l,o);E.position.x=B.max+n+A+t/2,E.position.y=-t/2,E.position.z=-r/2,W.add(E);l=new THREE.TextGeometry("Y(N)",{font:e,size:t,height:r}),E=new THREE.Mesh(l,o);E.position.x=-t/2,E.position.y=j.max+n+A+t/2,E.position.z=-r/2,W.add(E);s="Z(depth)",l=new THREE.TextGeometry(s,{font:e,size:t,height:r}),E=new THREE.Mesh(l,o);E.position.x=-t*s.length/3,E.position.y=-r/2,E.position.z=D.max+A+t/2,E.rotation.x=Math.PI/2,W.add(E)});for(K=[],J=0;J<=(B.max-B.min)/n;J++){var Q=B.min+n*J;0!==Q&&(K.push(new THREE.Vector3(Q,j.min,D.min)),K.push(new THREE.Vector3(Q,j.max,D.min)))}for(J=0;J<=(j.max-j.min)/n;J++){var $=j.min+n*J;0!==$&&(K.push(new THREE.Vector3(B.min,$,D.min)),K.push(new THREE.Vector3(B.max,$,D.min)))}geometry=(new THREE.BufferGeometry).setFromPoints(K),W.add(new THREE.LineSegments(geometry,material));K=[];K.push(new THREE.Vector3(B.min,0,D.min)),K.push(new THREE.Vector3(B.max+n,0,D.min)),geometry=(new THREE.BufferGeometry).setFromPoints(K);var ee=new THREE.Line(geometry,w);W.add(ee);K=[];K.push(new THREE.Vector3(B.max+n,O/2,D.min)),K.push(new THREE.Vector3(B.max+n,-O/2,D.min)),K.push(new THREE.Vector3(B.max+n+A,0,D.min)),geometry=(new THREE.BufferGeometry).setFromPoints(K);var te=new THREE.Mesh(geometry,w);W.add(te);K=[];K.push(new THREE.Vector3(0,j.min,D.min)),K.push(new THREE.Vector3(0,j.max+n,D.min)),geometry=(new THREE.BufferGeometry).setFromPoints(K);var ne=new THREE.Line(geometry,y);W.add(ne);K=[];K.push(new THREE.Vector3(-O/2,j.max+n,D.min)),K.push(new THREE.Vector3(O/2,j.max+n,D.min)),K.push(new THREE.Vector3(0,j.max+n+A,D.min)),geometry=(new THREE.BufferGeometry).setFromPoints(K);var ie=new THREE.Mesh(geometry,y);W.add(ie);K=[];K.push(new THREE.Vector3(0,0,D.min)),K.push(new THREE.Vector3(0,0,D.max)),geometry=(new THREE.BufferGeometry).setFromPoints(K);var re=new THREE.Line(geometry,H);W.add(re);K=[];K.push(new THREE.Vector3(-O/2,0,D.max)),K.push(new THREE.Vector3(O/2,0,D.max)),K.push(new THREE.Vector3(0,0,D.max+A)),geometry=(new THREE.BufferGeometry).setFromPoints(K);var oe=new THREE.Mesh(geometry,H);W.add(oe),spatialTrack=new CanvasGraph({renderer:I,scene:W,camera:X,controls:Y}),N.style.display="none",N.addEventListener("click",function(){Y.autoRotate=!1}),N.addEventListener("touchstart",function(){Y.autoRotate=!1})}function initHorizontalProjection(){var e,t=10,n=.3,i="#ff0000",r="#00ff00",o=baseColor,a=baseColor,s=o,c=document.getElementById("horizontalProjection");if(c.style.display="",configObj&&configObj.horizontalProjection){var l=configObj.horizontalProjection;t=l.xyGridNum||t,i=l.xAxisColor||i,r=l.yAxisColor||r,o=l.fontColor||o,a=l.realTrackLineColor||a,s=l.designTrackLineColor||s,n=l.fontSizeToUnitRatio||n}var E=new THREE.LineBasicMaterial({color:i,side:THREE.DoubleSide}),d=new THREE.LineBasicMaterial({color:r,side:THREE.DoubleSide}),u=new THREE.LineBasicMaterial({color:a,side:THREE.DoubleSide}),m=new THREE.LineBasicMaterial({color:s,side:THREE.DoubleSide}),f=getApproximateGridSize(xyFarthest,t,factorArray);fMul(t,f);e=f;var h=Math.min.apply(null,realXs.concat(designXs).concat(realTargetPoints.map(function(e){return e.x-e.r})).concat(designTargetPoints.map(function(e){return e.x-e.r}))),T=Math.min.apply(null,realYs.concat(designYs).concat(realTargetPoints.map(function(e){return e.y-e.r})).concat(designTargetPoints.map(function(e){return e.y-e.r}))),g=Math.max.apply(null,realYs.concat(designYs).concat(realTargetPoints.map(function(e){return e.y+e.r})).concat(designTargetPoints.map(function(e){return e.y+e.r}))),p=Math.max.apply(null,realXs.concat(designXs).concat(realTargetPoints.map(function(e){return e.x+e.r})).concat(designTargetPoints.map(function(e){return e.x+e.r})));h=h>=0?0:-fMul(Math.ceil(fDivision(-h,e)),e),T=T>=0?0:-fMul(Math.ceil(fDivision(-T,e)),e),g=g>=0?fMul(Math.ceil(fDivision(g,e)),e):e,p=p>=0?fMul(Math.ceil(fDivision(p,e)),e):e;var R=fSub(p,h),w=fSub(g,T),y=fSub(w,R),H=fMul(Math.ceil(fDivision(Math.abs(y),e)),e);y>0?Math.abs(h)>Math.abs(p)?p=fAdd(p,H):h=fSub(h,H):Math.abs(g)>Math.abs(T)?g=fAdd(g,H):T=fSub(T,H),R=fSub(p,h),w=fSub(g,T);var x=fDivision(fAdd(h,p),2),v=fDivision(fAdd(g,T),2),P=getCameraHeightFullContain(R,w,c.offsetWidth,c.offsetHeight,vViewAngle);P*=1.2;var M={min:h,max:p},b={min:T,max:g},L=new THREE.WebGLRenderer({antialias:!0,canvas:c,preserveDrawingBuffer:!0});L.setSize(c.offsetWidth,c.offsetHeight),L.setClearColor(new THREE.Color("white"));var k=new THREE.Scene,B=new THREE.PerspectiveCamera(vViewAngle,c.offsetWidth/c.offsetHeight,1,1e5);B.up.x=0,B.up.y=1,B.up.z=0,B.position.set(x,v,P),B.lookAt(x,v,0);var j=new THREE.OrbitControls(B,c);j.enableRotate=!1,j.target=new THREE.Vector3(x,v,0);var D="x",G=64,S=e/20,V=e*n,z=new THREE.MeshBasicMaterial({color:o,side:THREE.DoubleSide}),F=new THREE.Group;F.name="realDrillLines";var C=new THREE.PointsMaterial({color:baseColor,size:e/5}),O=new THREE.LineBasicMaterial({color:baseColor});realTargetPoints.forEach(function(e){var t=new THREE.BufferGeometry;t.setAttribute("position",new THREE.Float32BufferAttribute([e.x,e.y,0],3));var n=new THREE.Points(t,C);F.add(n);for(var i=[],r=0;r<=G;r++){var o=r/G*(2*Math.PI);i.push(new THREE.Vector3(Math.cos(o)*e.r+e.x,Math.sin(o)*e.r+e.y,0))}t=(new THREE.BufferGeometry).setFromPoints(i);var a=new THREE.Line(t,O);F.add(a);for(r=0;r<realTrackPoints.length-1;r++)if(!(e.depth<realTrackPoints[r].depth||e.depth>realTrackPoints[r+1].depth)){var s=(e.depth-realTrackPoints[r+1].depth)/(realTrackPoints[r].depth-realTrackPoints[r+1].depth),c=realTrackPoints[r+1].x+(realTrackPoints[r].x-realTrackPoints[r+1].x)*s,l=realTrackPoints[r+1].y+(realTrackPoints[r].y-realTrackPoints[r+1].y)*s;Math.sqrt(Math.pow(c-e.x,2)+Math.pow(l-e.y,2))<=e.r&&useFont(function(e){var t=new THREE.TextGeometry(D,{font:e,size:V,height:S}),n=new THREE.Mesh(t,z),i=(new THREE.Box3).setFromObject(n);n.position.x=c-(i.max.x-i.min.x)/2,n.position.y=l-(i.max.y-i.min.y)/2,n.position.z=-S/2,F.add(n)})}});var A=realTrackPoints.map(function(e){return new THREE.Vector3(e.x,e.y,0)});geometry=(new THREE.BufferGeometry).setFromPoints(A);var N=new THREE.Line(geometry,u);F.add(N),k.add(F);var I=new THREE.Group;I.name="designDrillLines";A=designTrackPoints.map(function(e){return new THREE.Vector3(e.x,e.y,0)});geometry=(new THREE.BufferGeometry).setFromPoints(A);var W=new THREE.Line(geometry,m);I.add(W);C=new THREE.PointsMaterial({color:baseColor,size:e/5});var X=new THREE.LineBasicMaterial({color:baseColor});designTargetPoints.forEach(function(e){var t=new THREE.BufferGeometry;t.setAttribute("position",new THREE.Float32BufferAttribute([e.x,e.y,0],3));var n=new THREE.Points(t,C);I.add(n);for(var i=[],r=0;r<=G;r++){var o=r/G*(2*Math.PI);i.push(new THREE.Vector3(Math.cos(o)*e.r+e.x,Math.sin(o)*e.r+e.y,0))}t=(new THREE.BufferGeometry).setFromPoints(i);var a=new THREE.Line(t,X);I.add(a);for(r=0;r<designTrackPoints.length-1;r++)if(!(e.depth<designTrackPoints[r].depth||e.depth>designTrackPoints[r+1].depth)){var s=(e.depth-designTrackPoints[r+1].depth)/(designTrackPoints[r].depth-designTrackPoints[r+1].depth),c=designTrackPoints[r+1].x+(designTrackPoints[r].x-designTrackPoints[r+1].x)*s,l=designTrackPoints[r+1].y+(designTrackPoints[r].y-designTrackPoints[r+1].y)*s;Math.sqrt(Math.pow(c-e.x,2)+Math.pow(l-e.y,2))<=e.r&&useFont(function(e){var t=new THREE.TextGeometry(D,{font:e,size:V,height:S}),n=new THREE.Mesh(t,z),i=(new THREE.Box3).setFromObject(n);n.position.x=c-(i.max.x-i.min.x)/2,n.position.y=l-(i.max.y-i.min.y)/2,n.position.z=-S/2,I.add(n)})}}),k.add(I);A=[];A.push(new THREE.Vector3(M.min,0,0)),A.push(new THREE.Vector3(M.max,0,0)),geometry=(new THREE.BufferGeometry).setFromPoints(A);var Y=new THREE.Line(geometry,E);k.add(Y);A=[];A.push(new THREE.Vector3(0,b.min,0)),A.push(new THREE.Vector3(0,b.max,0)),geometry=(new THREE.BufferGeometry).setFromPoints(A);var K=new THREE.Line(geometry,d);k.add(K);A=[];for(var U=0;U<=(M.max-M.min)/e;U++){var q=M.min+e*U;0!==q&&(A.push(new THREE.Vector3(q,b.min,0)),A.push(new THREE.Vector3(q,b.max,0)))}for(U=0;U<=(b.max-b.min)/e;U++){var J=b.min+e*U;0!==J&&(A.push(new THREE.Vector3(M.min,J,0)),A.push(new THREE.Vector3(M.max,J,0)))}geometry=(new THREE.BufferGeometry).setFromPoints(A),k.add(new THREE.LineSegments(geometry,material)),useFont(function(t){for(var i=e*n,r=e/20,a=new THREE.MeshBasicMaterial({color:o}),s=0;s<=(M.max-M.min)/e;s++){var c=fAdd(M.min,fMul(e,s)).toString();if("0"!==c){var l=new THREE.TextGeometry(c,{font:t,size:i,height:r}),E=new THREE.Mesh(l,a),d=(new THREE.Box3).setFromObject(E);E.position.x=M.min+e*s-i/2,E.position.y=(d.max.x-d.min.x)/2,E.position.z=-r/2,E.rotation.z=-Math.PI/2,k.add(E)}}for(s=0;s<=(b.max-b.min)/e;s++){c=fAdd(b.min,fMul(e,s)).toString(),l=new THREE.TextGeometry(c,{font:t,size:i,height:r}),E=new THREE.Mesh(l,a),d=(new THREE.Box3).setFromObject(E);E.position.x=-(d.max.x-d.min.x)/2,E.position.y=b.min+e*s-i/2,E.position.z=-r/2,k.add(E)}l=new THREE.TextGeometry("X(E)",{font:t,size:i,height:r}),E=new THREE.Mesh(l,a);E.position.x=M.max+i,E.position.y=-i/2,E.position.z=-r/2,k.add(E);l=new THREE.TextGeometry("Y(N)",{font:t,size:i,height:r}),E=new THREE.Mesh(l,a),d=(new THREE.Box3).setFromObject(E);E.position.x=-(d.max.x-d.max.y)/2,E.position.y=b.max+i,E.position.z=-r/2,k.add(E)}),horizontalProjection=new CanvasGraph({renderer:L,scene:k,camera:B,controls:j}),c.style.display="none"}function initVerticalProjection(){var e=10,t=.3,n="#ff0000",i="#00ff00",r="#8a2be2",o="#4caf50",a="#4caf50",s="#4caf50",c="#cf52a3",l="#cf52a3",E="#cf52a3",d="purple",u=hRealTrackPoints,m=hRealTargetPoints,f=hDesignTrackPoints,h=hDesignTargetPoints,T=directionText;config&&(e=config.gridNum||e,n=config.hAxisColor||n,i=config.depthAxisColor||i,r=config.fontColor||r,t=config.fontSizeToUnitRatio||t,o=config.realTrackLineColor||o,c=config.designTrackLineColor||c,d=config.directionLabelColor||d);var g=new THREE.LineBasicMaterial({color:n}),p=new THREE.LineBasicMaterial({color:i}),R=new THREE.LineBasicMaterial({color:o}),w=new THREE.LineBasicMaterial({color:c}),y=Math.max(Math.max.apply(null,realDepths),Math.abs(Math.max.apply(null,u)),Math.abs(Math.min.apply(null,u))),H=getApproximateGridSize(y,e,factorArray),x=function(e){return-e},v=function(e){return-e},P={min:-fMul(Math.round(e/2),H),max:fMul(Math.round(e/2),H)},M={min:x(fMul(e,H)),max:0},b=document.getElementById(canvasId);b.style.display="";var L=new THREE.WebGLRenderer({antialias:!0,canvas:b,preserveDrawingBuffer:!0}),k=(M.min+M.max)/2,B=getCameraHeightFullContain(P.max-P.min,M.max-M.min,b.offsetWidth,b.offsetHeight,vViewAngle);B*=1.2;var j=new THREE.Scene,D=new THREE.PerspectiveCamera(vViewAngle,b.offsetWidth/b.offsetHeight,1,1e5);D.position.set(0,k,B),D.lookAt(0,k,0),L.setSize(b.offsetWidth,b.offsetHeight),L.setClearColor(new THREE.Color("white"));var G=new THREE.OrbitControls(D,b);G.enableRotate=!1,G.target=new THREE.Vector3(0,k,0),b.style.display="none";for(var S=[],V=0;V<=(P.max-P.min)/H;V++){var z=P.min+H*V;0!==z&&(S.push(new THREE.Vector3(z,M.min,0)),S.push(new THREE.Vector3(z,M.max,0)))}for(V=0;V<=(M.max-M.min)/H;V++){var F=M.min+H*V;0!==F&&(S.push(new THREE.Vector3(P.min,F,0)),S.push(new THREE.Vector3(P.max,F,0)))}geometry=(new THREE.BufferGeometry).setFromPoints(S),j.add(new THREE.LineSegments(geometry,material));S=[];S.push(new THREE.Vector3(P.min,0,0)),S.push(new THREE.Vector3(P.max,0,0)),geometry=(new THREE.BufferGeometry).setFromPoints(S);var C=new THREE.Line(geometry,g);j.add(C);S=[];S.push(new THREE.Vector3(0,M.min,0)),S.push(new THREE.Vector3(0,M.max,0)),geometry=(new THREE.BufferGeometry).setFromPoints(S);var O=new THREE.Line(geometry,p);j.add(O);var A=new THREE.Group;A.name="realDrillLines";S=realTrackPoints.map(function(e,t){return new THREE.Vector3(u[t],x(e.depth),0)});geometry=(new THREE.BufferGeometry).setFromPoints(S);var N=new THREE.Line(geometry,R);if(A.add(N),realKop){S=[];S.push(new THREE.Vector3(-H/5,x(realKop),0)),S.push(new THREE.Vector3(H/5,x(realKop),0));var I=new THREE.LineBasicMaterial({color:a});geometry=(new THREE.BufferGeometry).setFromPoints(S);var W=new THREE.Line(geometry,I);A.add(W)}if(realTargetPoints.length>0){var X=new THREE.LineBasicMaterial({color:s});realTargetPoints.forEach(function(e,t){var n=[];n.push(new THREE.Vector3(m[t]-e.r,x(e.depth),0)),n.push(new THREE.Vector3(m[t]+e.r,x(e.depth),0)),geometry=(new THREE.BufferGeometry).setFromPoints(n);var i=new THREE.Line(geometry,X);A.add(i)})}j.add(A);var Y=new THREE.Group;Y.name="designDrillLines";S=designTrackPoints.map(function(e,t){return new THREE.Vector3(f[t],x(e.depth),0)});geometry=(new THREE.BufferGeometry).setFromPoints(S);N=new THREE.Line(geometry,w);if(Y.add(N),designKop){S=[];S.push(new THREE.Vector3(-H/5,x(designKop),0)),S.push(new THREE.Vector3(H/5,x(designKop),0));I=new THREE.LineBasicMaterial({color:l});geometry=(new THREE.BufferGeometry).setFromPoints(S);W=new THREE.Line(geometry,I);Y.add(W)}if(designTargetPoints.length>0){X=new THREE.LineBasicMaterial({color:E});designTargetPoints.forEach(function(e,t){var n=[];n.push(new THREE.Vector3(h[t]-e.r,x(e.depth),0)),n.push(new THREE.Vector3(h[t]+e.r,x(e.depth),0)),geometry=(new THREE.BufferGeometry).setFromPoints(n);var i=new THREE.Line(geometry,X);Y.add(i)})}j.add(Y);var K=new THREE.MeshBasicMaterial({color:r}),U=H*t,q=H/20;useFont(function(e){for(var t=0;t<=(P.max-P.min)/H;t++){var n=fAdd(P.min,fMul(H,t)).toString(),i=new THREE.TextGeometry(n,{font:e,size:U,height:q}),r=new THREE.Mesh(i,K);r.rotation.z=-Math.PI/2;var o=(new THREE.Box3).setFromObject(r);r.position.x=P.min+H*t-U/2,r.position.y=o.max.y-o.min.y+U/2,r.position.z=-q/4,j.add(r)}for(t=0;t<=(M.max-M.min)/H;t++){n=v(fAdd(M.min,fMul(H,t))).toString();if("0"!==n){i=new THREE.TextGeometry(n,{font:e,size:U,height:q}),r=new THREE.Mesh(i,K),o=(new THREE.Box3).setFromObject(r);r.position.x=-(o.max.x-o.min.x)/2,r.position.y=M.min+H*t+U/4,r.position.z=-q/2,j.add(r)}}});var J=new THREE.MeshBasicMaterial({color:d,side:THREE.DoubleSide}),Z=H/2,_=H/3,Q=P.max+H/3,$=M.max-H/2+_/2,ee=new THREE.Shape;ee.moveTo(Q,$),ee.lineTo(Q+Z/4,$-_/2),ee.lineTo(Q,$-_),ee.lineTo(Q+Z,$-_/2),ee.lineTo(Q,$),geometry=new THREE.ShapeGeometry(ee);var te=new THREE.Mesh(geometry,J);j.add(te),useFont(function(e){var t=T,n=new THREE.TextGeometry(t,{font:e,size:U,height:q}),i=new THREE.Mesh(n,K),r=(new THREE.Box3).setFromObject(i);i.position.x=Q+Z/2-(r.max.x-r.min.x)/2,i.position.y=$-_-1.5*U,i.position.z=-q/2,j.add(i)});var ne=new CanvasGraph({renderer:L,scene:j,camera:D,controls:G});"verticalProjectionEW"===canvasId?verticalProjectionEW=ne:"verticalProjectionNS"===canvasId&&(verticalProjectionNS=ne),b.style.display="none"}function initVerticalProjectionEW(){canvasId="verticalProjectionEW",config=configObj&&configObj.verticalProjectionEW,hRealTargetPoints=realTargetPoints.map(function(e){return e.x}),hDesignTargetPoints=designTargetPoints.map(function(e){return e.x}),hRealTrackPoints=realXs,hDesignTrackPoints=designXs,directionText="E",initVerticalProjection()}function initVerticalProjectionNS(){canvasId="verticalProjectionNS",config=configObj&&configObj.verticalProjectionNS,hRealTargetPoints=realTargetPoints.map(function(e){return e.y}),hDesignTargetPoints=designTargetPoints.map(function(e){return e.y}),hRealTrackPoints=realYs,hDesignTrackPoints=designYs,directionText="N",initVerticalProjection()}function postDrawFinished(){var e=document.getElementById("loadingText");e&&(e.style.display="none")}function triggerInitError(e){var t=document.getElementById("loadingText");throw t&&(t.innerText=e,t.style.color="red"),Error(e)}function init(){loadConfigFile(configPath).then(function(){return fetchRealTrackPoints(initWellNO)}).then(function(){return fetchRealTargetPoints(initWellNO)}).then(function(){return fetchDesignTrackPoints(initWellNO)}).then(function(){return fetchDesignTargetPoints(initWellNO)}).then(dataProcess).then(initGraph)}function initGraph(){var e=configObj.defaultGraphType||defaultGraphType;urlParams.graphType&&(e=urlParams.graphType),switchGraph(e),postDrawFinished()}function switchGraph(e){var t;curGraph&&curGraph.hide(),"verticalProjectionEW"===e?(verticalProjectionEW||initVerticalProjectionEW(),t=verticalProjectionEW):"verticalProjectionNS"===e?(verticalProjectionNS||initVerticalProjectionNS(),t=verticalProjectionNS):"horizontalProjection"===e?(horizontalProjection||initHorizontalProjection(),t=horizontalProjection):(spatialTrack||initSpatialTrack(),t=spatialTrack),curGraph=t,curGraph.show();var n=document.querySelector("#type-select-area input[value="+e+"]");n.checked=!0;var i=curGraph.getRealDrillingLineVisible(),r=curGraph.getDesignDrillingLineVisible(),o=document.getElementById("check-real-line");o.checked=i;var a=document.getElementById("check-design-line");a.checked=r}function dataProcess(){return new Promise(function(e){realXs=realTrackPoints.map(function(e){return e.x}),designXs=designTrackPoints.map(function(e){return e.x}),realYs=realTrackPoints.map(function(e){return e.y}),designYs=designTrackPoints.map(function(e){return e.y}),realDepths=realTrackPoints.map(function(e){return e.depth}),designDepths=designTrackPoints.map(function(e){return e.depth}),xyFarthest=Math.max(Math.abs(Math.max.apply(null,realXs)),Math.abs(Math.min.apply(null,realXs)),Math.abs(Math.max.apply(null,realYs)),Math.abs(Math.min.apply(null,realYs)),Math.abs(Math.max.apply(null,designXs)),Math.abs(Math.min.apply(null,designXs)),Math.abs(Math.max.apply(null,designYs)),Math.abs(Math.min.apply(null,designYs))),e()})}function loadConfigFile(e){return new Promise(function(t){axios.get(e,{transformResponse:function(e){try{var t=JSON5.parse(e)}catch(e){console.error("配置对象不是一个有效的对象!")}return t}}).then(function(e){configObj=e.data,externalDataFetch=new axios.create({baseURL:configObj.externalDataBasePath}),configObj.defaultTargetRadius&&configObj.defaultTargetRadius>=0&&(defaultTargetRadius=configObj.defaultTargetRadius),configObj.defaultWellNO&&!urlParams.wellNO&&(initWellNO=configObj.defaultWellNO),t()}).catch(function(e){console.error("配置文件加载失败,请检查配置文件的位置!")})})}function fetchRealTargetPoints(e){return new Promise(function(t){externalDataFetch.get("/api/jxjs/getBd",{params:{jhdm:e}}).then(function(e){try{realTargetPoints=e.data}catch(e){triggerInitError("靶点数据不是一个有效的对象!")}realTargetPoints=parseTargetPointsData(realTargetPoints),t()}).catch(function(){triggerInitError("靶点数据加载失败!")})})}function fetchDesignTargetPoints(e){return new Promise(function(t){externalDataFetch.get("/api/jxjs/getSjBd",{params:{jhdm:e}}).then(function(e){try{designTargetPoints=e.data}catch(e){triggerInitError("设计靶点数据不是一个有效的对象!")}designTargetPoints=parseTargetPointsData(designTargetPoints),t()}).catch(function(){triggerInitError("设计靶点数据加载失败!")})})}function fetchRealTrackPoints(e){return new Promise(function(t){externalDataFetch.get("api/jxjs/getLxAll",{params:{jhdm:e}}).then(function(e){try{realTrackPoints=e.data}catch(e){triggerInitError("实钻轨迹点数据不是一个有效的对象!")}realTrackPoints[0]&&realTrackPoints[0].zxd&&(realKop=parseFloat(realTrackPoints[0].zxd)),realTrackPoints=parseTrackPointsData(realTrackPoints),t()}).catch(function(){triggerInitError("加载实钻轨迹点数据失败!")})})}function fetchDesignTrackPoints(e){return new Promise(function(t){externalDataFetch.get("/api/jxjs/getSjAll",{params:{jhdm:e}}).then(function(e){try{designTrackPoints=e.data}catch(e){triggerInitError("设计钻线轨迹点数据不是一个有效的对象!")}designTrackPoints[0]&&designTrackPoints[0].zxd&&(designKop=parseFloat(designTrackPoints[0].zxd)),designTrackPoints=parseTrackPointsData(designTrackPoints),t()}).catch(function(){triggerInitError("加载设计钻线轨迹点数据失败!")})})}function fetchWellNOByPrefix(e){return new Promise(function(t){externalDataFetch.get("/api/jxjs/getJh",{params:{jhdm:e}}).then(function(e){t(e.data)}).catch(function(e){console.error("无法获取井号数据!")})})}function buildWellNameSelectDropdown(e){var t='<div class="dropdown is-active">';return t+='  <div class="dropdown-menu" role="menu">',t+='    <div class="dropdown-content">',t+=e.map(function(e){var t='<div class="dropdown-item" data-wellno=';return t+=e.jhdm+">"+e.jhbm+"</div>",t}).join(""),t+="</div></div></div>",t}function parseTargetPointsData(e){return e.map(function(e){return{y:e.xzb-e.jkzzbx,x:e.yzb-e.jkhzby,depth:e.csb,r:null===e.ybbqbj?defaultTargetRadius:e.ybbqbj}})}function parseTrackPointsData(e){return e.map(function(e){return{x:parseFloat(e.dxpy),y:parseFloat(e.nbpy),depth:parseFloat(e.cs)}})}function eventListener(){var e=document.getElementById("head-burger"),t=document.getElementById("head-menu");e.addEventListener("click",function(){e.classList.toggle("is-active"),t.classList.toggle("is-active")});for(var n=document.getElementsByName("typeSel"),i=0;i<n.length;i++)n[i].addEventListener("change",function(){switchGraph(this.value),t.classList.toggle("is-active"),e.classList.toggle("is-active")});var r=document.getElementById("reset-btn");r&&r.addEventListener("click",function(){curGraph&&curGraph.reset()});var o=document.getElementById("export-btn");o&&o.addEventListener("click",function(){curGraph&&curGraph.export()});var a=document.querySelectorAll("#select-line-type input[type='checkbox']");for(i=0;i<a.length;i++)a[i].addEventListener("change",function(){"check-design-line"===this.id?curGraph.setDesignDrillingLine(this.checked):"check-real-line"===this.id&&curGraph.setRealDrillingLine(this.checked)});var s=document.getElementById("well-name-input"),c=document.getElementById("well-name-dropdown"),l=!1;s.addEventListener("compositionend",function(){l=!1}),s.addEventListener("compositionstart",function(){l=!0}),s.addEventListener("keyup",debounce(function(){l||(""!==s.value?fetchWellNOByPrefix(s.value).then(function(e){if(0!==e.length){c.innerHTML=buildWellNameSelectDropdown(e);for(var t=c.getElementsByClassName("dropdown-item"),n=0;n<t.length;n++){var i=t[n];i.addEventListener("click",function(){var e=i.dataset.wellno,t=location.origin+location.pathname+"?wellNO="+e;location.assign(t)})}}else c.innerHTML=""}):c.innerHTML="")},250)),document.addEventListener("click",function(e){for(var t=e.target||e.srcElement;t;){if(t===c)return;t=t.parentNode}c.innerHTML=""})}function CanvasGraph(e){function t(){requestAnimationFrame(t),r&&r.update()}function n(){o.render(a,s)}function i(){if("none"!==c.style.display){var e=c.offsetWidth,t=c.offsetHeight;s.aspect=e/t,s.updateProjectionMatrix(),o.setSize(e,t),n()}}var r=e.controls,o=e.renderer,a=e.scene,s=e.camera,c=null;if(this.canvas=c,!o)throw Error("没有渲染器参数!");if(!s)throw Error("没有相机参数!");c=o.domElement,r?(r.addEventListener("change",n),t()):n(),window.addEventListener("resize",i),this.show=function(){c&&c.style&&(c.style.display="",n())},this.hide=function(){c&&c.style&&(c.style.display="none")},this.reset=function(){r&&r.reset()},this.export=function(){if(c){var e=document.createElement("a");e.download="canvas.png",e.href=c.toDataURL(),e.click(),e.remove()}},this.getRealDrillingLineVisible=function(){var e=a.getObjectByName("realDrillLines");return e&&e.visible},this.getDesignDrillingLineVisible=function(){var e=a.getObjectByName("designDrillLines");return e&&e.visible},this.setRealDrillingLine=function(e){var t=a.getObjectByName("realDrillLines");t&&"boolean"==typeof e&&(t.visible=e,n())},this.setDesignDrillingLine=function(e){var t=a.getObjectByName("designDrillLines");t&&"boolean"==typeof e&&(t.visible=e,n())},r&&(this.startRotate=function(){r.autoRotate=!0},this.stopRotate=function(){r.autoRotate=!1})}function debounce(e,t){var n;return function(){var i=this,r=arguments;n&&clearTimeout(n),n=setTimeout(function(){e.apply(i,r)},t)}}function parseUrlParam(e){for(var t,n={},i=e.slice(e.indexOf("?")+1).split("&"),r=0;r<i.length;r++)t=i[r].split("="),n[t[0]]=t[1];return n}function getApproximateGridSize(e,t,n){if(0!==n.length){n.sort(function(e,t){return t-e});for(var i=fDivision(e,t),r=0;r<n.length;r++){if(n[r]<=i){i=n[r];break}if(r===n.length-1)return}var o=Math.ceil(fDivision(e,fMul(i,t)));return i=fMul(i,o),i}}function getCameraHeightFullContain(e,t,n,i,r){var o;if(n/i>e/t)o=t/2/Math.tan(THREE.MathUtils.degToRad(r/2));else{var a=t*(i/n/(t/e));o=a/2/Math.tan(THREE.MathUtils.degToRad(r/2))}return o}function fMul(e,t){var n,i,r=e+"",o=t+"";n=r.split(".")[1]?r.split(".")[1].length:0,i=o.split(".")[1]?o.split(".")[1].length:0;var a=Math.pow(10,n+i);return Number(r.replace(".",""))*Number(o.replace(".",""))/a}function fAdd(e,t){var n,i,r=e+"",o=t+"";n=r.split(".")[1]?r.split(".")[1].length:0,i=o.split(".")[1]?o.split(".")[1].length:0;var a=Math.pow(10,Math.max(n,i));return(fMul(e,a)+fMul(t,a))/a}function fSub(e,t){var n,i,r=e+"",o=t+"";n=r.split(".")[1]?r.split(".")[1].length:0,i=o.split(".")[1]?o.split(".")[1].length:0;var a=Math.pow(10,Math.max(n,i));return(fMul(e,a)-fMul(t,a))/a}function fDivision(e,t){var n,i,r=e+"",o=t+"";n=r.split(".")[1]?r.split(".")[1].length:0,i=o.split(".")[1]?o.split(".")[1].length:0;var a=Math.pow(10,Math.max(i,n)),s=fMul(e,a),c=fMul(t,a);return s/c}window.addEventListener("load",function(){init(),eventListener()});var realKop,designKop,geometry,configObj,externalDataFetch,xyFarthest,realXs,designXs,realYs,designYs,realDepths,designDepths,curGraph,spatialTrack,verticalProjectionEW,horizontalProjection,verticalProjectionNS,realTargetPoints,canvasId,config,hRealTargetPoints,hRealTrackPoints,hDesignTargetPoints,hDesignTrackPoints,directionText,urlParams=parseUrlParam(location.href),defaultTargetRadius=0,defaultWellNO="",defaultGraphType="spatialTrack",initWellNO=urlParams.wellNO||defaultWellNO,vViewAngle=45,fontPath="./font/optimer_regular.typeface.json",configPath="config.json",baseColor="#000000",factorArray=[1e4,1e3,100,10,1,.1,.01,.001,1e-4,1e-5,1e-6],realTrackPoints=[],designTrackPoints=[],designTargetPoints=[],material=new THREE.LineBasicMaterial({color:baseColor}),useFont=function(){var e=null,t=null,n=[],i=new THREE.FontLoader;return i.load(fontPath,function(e){t=e}),function(i){t?i(t):(n.push(i),e||(e=setInterval(function(){t&&(n.forEach(function(e){e(t)}),n.splice(0,n.length),clearInterval(e))},10)))}}();